<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Handbell Web App - Jingle Bells</title>
    <style>
      body {
        margin: 0;
        padding: 0;
		background: url("winter.jpg") no-repeat center center fixed;
        background-size: cover;
        font-family: sans-serif;
      }

      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
      }

      #controls label {
        display: inline-block;
        margin-right: 8px;
      }

      #controls select,
      #controls button {
        margin-right: 8px;
      }

      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }

      input[type="range"] {
        width: 120px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label for="songSelect">Song:</label>
      <select id="songSelect"></select>

      <label for="bpmSlider">BPM:</label>
      <input
        type="range"
        id="bpmSlider"
        min="40"
        max="200"
        step="1"
        value="90"
      />
      <span id="bpmValue">90</span>

      <button id="startBtn">Start</button>
      <button id="pauseBtn">Pause</button>
      <button id="stopBtn">Stop</button>
    </div>

    <canvas id="handbellCanvas"></canvas>

    <script>
      /////////////////////////////////
      // 1) SONG DATA
      /////////////////////////////////
      const songs = [
        {
          title: "Jingle Bells",
          defaultBPM: 90,
          notes: [
            { note: 3, position: 0 },
            { note: 3, position: 4 },
            { note: 3, position: 8 },
            { note: 3, position: 16 },
            { note: 3, position: 20 },
            { note: 3, position: 24 },
            { note: 3, position: 32 },
            { note: 5, position: 36 },
            { note: 1, position: 40 },
            { note: 2, position: 44 },
            { note: 3, position: 48 },
            { note: 4, position: 64 },
            { note: 4, position: 68 },
            { note: 4, position: 72 },
            { note: 4, position: 76 },
            { note: 4, position: 80 },
            { note: 3, position: 84 },
            { note: 3, position: 88 },
            { note: 3, position: 92 },
            { note: 3, position: 96 },
            { note: 2, position: 100 },
            { note: 2, position: 104 },
            { note: 3, position: 108 },
            { note: 2, position: 112 },
            { note: 5, position: 120 },
            { note: 3, position: 128 },
            { note: 3, position: 132 },
            { note: 3, position: 136 },
            { note: 3, position: 144 },
            { note: 3, position: 148 },
            { note: 3, position: 152 },
            { note: 3, position: 160 },
            { note: 5, position: 164 },
            { note: 1, position: 168 },
            { note: 2, position: 172 },
            { note: 3, position: 176 },
            { note: 4, position: 192 },
            { note: 4, position: 196 },
            { note: 4, position: 200 },
            { note: 4, position: 204 },
            { note: 4, position: 208 },
            { note: 3, position: 212 },
            { note: 3, position: 216 },
            { note: 3, position: 220 },
            { note: 5, position: 224 },
            { note: 5, position: 228 },
            { note: 4, position: 232 },
            { note: 2, position: 236 },
            { note: 1, position: 240 },
          ],
        },
		{
          title: "Jolly Old St Nicholas",
          defaultBPM: 80,
          notes: [
            { note: 7, position: 0 },
			{ note: 7, position: 4 },
			{ note: 7, position: 8 },
			{ note: 7, position: 12 },
			{ note: 6, position: 16 },
			{ note: 6, position: 20 },
			{ note: 6, position: 24 },
			{ note: 5, position: 32 },
			{ note: 5, position: 36 },
			{ note: 5, position: 40 },
			{ note: 5, position: 44 },
			{ note: 7, position: 48 },
			{ note: 3, position: 64 },
			{ note: 3, position: 68 },
			{ note: 3, position: 72 },
			{ note: 3, position: 76 },
			{ note: 2, position: 80 },
			{ note: 2, position: 84 },
			{ note: 5, position: 88 },
			{ note: 6, position: 96 },
			{ note: 5, position: 100 },
			{ note: 6, position: 104 },
			{ note: 7, position: 108 },
			{ note: 6, position: 112 },
			{ note: 7, position: 128 },
			{ note: 7, position: 132 },
			{ note: 7, position: 136 },
			{ note: 7, position: 140 },
			{ note: 6, position: 144 },
			{ note: 6, position: 148 },
			{ note: 6, position: 152 },
			{ note: 5, position: 160 },
			{ note: 5, position: 164 },
			{ note: 5, position: 168 },
			{ note: 5, position: 172 },
			{ note: 7, position: 176 },
			{ note: 3, position: 192 },
			{ note: 3, position: 196 },
			{ note: 3, position: 200 },
			{ note: 3, position: 204 },
			{ note: 2, position: 208 },
			{ note: 2, position: 212 },
			{ note: 5, position: 216 },
			{ note: 6, position: 224 },
			{ note: 5, position: 228 },
			{ note: 6, position: 232 },
			{ note: 7, position: 236 },
			{ note: 5, position: 240 }
          ],
        },
		{
          title: "The First Noel",
          defaultBPM: 60,
          notes: [
            { note: 3, position: 0 },
			{ note: 2, position: 2 },
			{ note: 1, position: 4 },
			{ note: 2, position: 10 },
			{ note: 3, position: 12 },
			{ note: 4, position: 14 },
			{ note: 5, position: 16 },
			{ note: 6, position: 24 },
			{ note: 7, position: 26 },
			{ note: 8, position: 28 },
			{ note: 7, position: 32 },
			{ note: 6, position: 36 },
			{ note: 5, position: 40 },
			{ note: 6, position: 48 },
			{ note: 7, position: 50 },
			{ note: 8, position: 52 },
			{ note: 7, position: 56 },
			{ note: 6, position: 60 },
			{ note: 5, position: 64 },
			{ note: 6, position: 68 },
			{ note: 7, position: 72 },
			{ note: 8, position: 76 },
			{ note: 5, position: 80 },
			{ note: 4, position: 84 },
			{ note: 3, position: 88 },
			{ note: 3, position: 96 },
			{ note: 2, position: 98 },
			{ note: 1, position: 100 },
			{ note: 2, position: 106 },
			{ note: 3, position: 108 },
			{ note: 4, position: 110 },
			{ note: 5, position: 112 },
			{ note: 6, position: 120 },
			{ note: 7, position: 122 },
			{ note: 8, position: 124 },
			{ note: 7, position: 128 },
			{ note: 6, position: 132 },
			{ note: 5, position: 136 },
			{ note: 6, position: 144 },
			{ note: 7, position: 146 },
			{ note: 8, position: 148 },
			{ note: 7, position: 152 },
			{ note: 6, position: 156 },
			{ note: 5, position: 160 },
			{ note: 6, position: 164 },
			{ note: 7, position: 168 },
			{ note: 8, position: 172 },
			{ note: 5, position: 176 },
			{ note: 4, position: 180 },
			{ note: 3, position: 184 },
			{ note: 3, position: 192 },
			{ note: 2, position: 194 },
			{ note: 1, position: 196 },
			{ note: 2, position: 202 },
			{ note: 3, position: 204 },
			{ note: 4, position: 206 },
			{ note: 5, position: 208 },
			{ note: 8, position: 216 },
			{ note: 7, position: 218 },
			{ note: 6, position: 220 },
			{ note: 6, position: 228 },
			{ note: 5, position: 232 },
			{ note: 8, position: 244 },
			{ note: 7, position: 248 },
			{ note: 6, position: 252 },
			{ note: 5, position: 256 },
			{ note: 6, position: 260 },
			{ note: 7, position: 264 },
			{ note: 8, position: 268 },
			{ note: 5, position: 272 },
			{ note: 4, position: 276 },
			{ note: 3, position: 280 },
			{ note: 3, position: 288 },
			{ note: 2, position: 290 },
			{ note: 1, position: 292 },
			{ note: 2, position: 298 },
			{ note: 3, position: 300 },
			{ note: 4, position: 302 },
			{ note: 5, position: 304 },
			{ note: 8, position: 312 },
			{ note: 7, position: 314 },
			{ note: 6, position: 316 },
			{ note: 6, position: 324 },
			{ note: 5, position: 328 },
			{ note: 8, position: 340 },
			{ note: 7, position: 344 },
			{ note: 6, position: 348 },
			{ note: 5, position: 352 },
			{ note: 6, position: 356 },
			{ note: 7, position: 360 },
			{ note: 8, position: 364 },
			{ note: 5, position: 368 },
			{ note: 4, position: 372 },
			{ note: 3, position: 376 }
          ],
        }
        // If you have other songs, add them here...
      ];

      /////////////////////////////////
      // 2) UI HOOKUP
      /////////////////////////////////
      const songSelect = document.getElementById("songSelect");
      const bpmSlider = document.getElementById("bpmSlider");
      const bpmValue = document.getElementById("bpmValue");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const stopBtn = document.getElementById("stopBtn");

      // Populate the song dropdown
      songs.forEach((s, index) => {
        const opt = document.createElement("option");
        opt.value = index;
        opt.textContent = s.title;
        songSelect.appendChild(opt);
      });
      songSelect.value = 0; // default: first song

      // Canvas + 2D context
      const canvas = document.getElementById("handbellCanvas");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // Update BPM label text
      function updateBPMLabel(value) {
        bpmValue.textContent = value;
      }
      updateBPMLabel(bpmSlider.value);

      /////////////////////////////////
      // 3) GLOBALS FOR ANIMATION
      /////////////////////////////////
      let currentSongIndex = 0;
      let currentSong = songs[0];

      let isRunning = false;
      let songTime = 0; // seconds elapsed
      let lastFrameTime = null;

      // Each note => { note, spawnTime, hasSpawned, x, y, rung }
      let activeNotes = [];

      // Bell colors (1–8 => these indices => 0–7)
      const bellColors = [
        "red",
        "orange",
        "yellow",
        "green",
        "lightblue",
        "darkblue",
        "purple",
        "white",
      ];

      // Horizontal line at 75% from top
      let horizontalLineY = canvas.height * 0.75;
      const NUM_BELLS = 8;
      function getLineSpacing() {
        return canvas.width / (NUM_BELLS + 1);
      }

      /////////////////////////////////
      // 4) SONG/BPM LOGIC
      /////////////////////////////////
      function getCurrentBPM() {
        return parseInt(bpmSlider.value, 10);
      }

      function calculateNoteTimes() {
        const bpm = getCurrentBPM();
        const secPer16th = (60 / bpm) / 4;

        activeNotes = currentSong.notes.map((n) => {
          const spawnTime = n.position * secPer16th; 
          return {
            note: n.note,
            spawnTime,
            hasSpawned: false,
            x: 0,
            y: 0,
            rung: false,
          };
        });
      }

      function handleBPMChange() {
        const oldSongTime = songTime; 
        calculateNoteTimes();
        // We'll keep the same "songTime" so the spawn logic updates accordingly.
        // Some notes might spawn immediately if "songTime" is now beyond their spawnTime.
        songTime = oldSongTime;
      }

      bpmSlider.addEventListener("input", () => {
        updateBPMLabel(bpmSlider.value);
        if (isRunning) {
          handleBPMChange();
        } else {
          calculateNoteTimes();
          draw();
        }
      });

      songSelect.addEventListener("change", () => {
        stopSong(); 
        currentSongIndex = parseInt(songSelect.value, 10);
        currentSong = songs[currentSongIndex];
        bpmSlider.value = currentSong.defaultBPM;
        updateBPMLabel(bpmSlider.value);
        calculateNoteTimes();
        draw();
      });

      /////////////////////////////////
      // 5) ANIMATION LOOP
      /////////////////////////////////
      function animate(timestamp) {
        if (!isRunning) return;
        if (lastFrameTime === null) {
          lastFrameTime = timestamp;
        }
        const deltaTime = (timestamp - lastFrameTime) / 1000;
        lastFrameTime = timestamp;
        songTime += deltaTime;

        update(deltaTime);
        draw();

        requestAnimationFrame(animate);
      }

      function update(deltaTime) {
        horizontalLineY = canvas.height * 0.75;

        // Spawn notes
        for (let n of activeNotes) {
          if (!n.hasSpawned && songTime >= n.spawnTime) {
            n.hasSpawned = true;
            const bellIndex = n.note - 1;
            n.x = getLineSpacing() * (bellIndex + 1);
            n.y = -20;
          }
        }

        // Move notes
        for (let n of activeNotes) {
          if (n.hasSpawned) {
            // Fall speed in pixels/sec
            n.y += 100 * deltaTime;

            if (!n.rung && n.y >= horizontalLineY) {
              console.log(`Bell ${n.note} rung at t=${songTime.toFixed(2)}s`);
              n.rung = true;
            }
          }
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Vertical lines
        ctx.lineWidth = 3;
        const spacing = getLineSpacing();
        for (let i = 1; i <= NUM_BELLS; i++) {
          const lineX = spacing * i;
          ctx.strokeStyle = bellColors[i - 1]; 
          ctx.beginPath();
          ctx.moveTo(lineX, 0);
          ctx.lineTo(lineX, canvas.height);
          ctx.stroke();
        }

        // Horizontal line
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0, horizontalLineY);
        ctx.lineTo(canvas.width, horizontalLineY);
        ctx.stroke();

        // Draw notes
        for (let n of activeNotes) {
          if (n.hasSpawned) {
            const color = bellColors[n.note - 1];
            ctx.beginPath();
            ctx.arc(n.x, n.y, 20, 0, 2 * Math.PI);

            ctx.lineWidth = 2;
            ctx.strokeStyle = "black";
            ctx.stroke();
            ctx.fillStyle = color;
            ctx.fill();
          }
        }
      }

      /////////////////////////////////
      // 6) CONTROL BUTTONS
      /////////////////////////////////
      startBtn.addEventListener("click", startSong);
      pauseBtn.addEventListener("click", pauseSong);
      stopBtn.addEventListener("click", stopSong);

      function startSong() {
        if (!isRunning) {
          isRunning = true;
          lastFrameTime = null;
          requestAnimationFrame(animate);
        }
      }

      function pauseSong() {
        isRunning = false;
      }

      function stopSong() {
        isRunning = false;
        songTime = 0;
        lastFrameTime = null;
        calculateNoteTimes();
        draw();
      }

      /////////////////////////////////
      // 7) INIT
      /////////////////////////////////
      currentSong = songs[0];
      bpmSlider.value = currentSong.defaultBPM;
      updateBPMLabel(bpmSlider.value);
      calculateNoteTimes();
      draw();
    </script>
  </body>
</html>
